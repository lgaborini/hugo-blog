---
title: "Controlling long outputs with knitr hooks"
draft: false
categories: ["blog"]
tags: ["R", "blogdown", "knitr", "hooks", "snippets"]
date: "2018-05-30"
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This blog is written in a combination of Markdown and R Markdown (using the R package {{% cran "blogdown" %}}).</p>
<p>As such, some R Markdown posts contain code chunks who generate very lengthy and verbose output.<br />
An example is this one, which generates a sequence of strings separated by newlines:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##             [,1]        [,2]       [,3]        [,4]        [,5]       [,6]
##  [1,]  0.3178022 -0.77914214 -0.5355179  0.99033166  0.78377109  1.2607385
##  [2,]  0.4755557 -0.69553890 -0.3736133 -1.88588859  0.20214147  0.1512767
##  [3,]  1.5588305 -0.87689253  2.7109762  0.40236202  1.04827576 -1.5561023
##  [4,] -0.7573477  2.26176730  0.1172298 -0.21508546  0.77193035 -0.5873326
##  [5,]  1.5681508  0.73915384  2.3615882 -1.61843638  0.71444727  0.3688652
##  [6,]  0.1446999  0.56299013 -1.2977432  1.51403016  0.02516633  0.3407814
##  [7,]  1.7496177 -1.03992657 -0.8252937 -0.59131797 -0.02623323  0.1721575
##  [8,] -0.6059939  0.05349085 -2.7153895  0.03608505 -1.31440403  0.2664825
##  [9,] -0.3590272 -0.68621600 -0.7448181  0.51615882 -0.45114150 -0.1134562
## [10,]  0.2853089  0.56244473 -0.7290753 -1.85662466  0.35790886  0.4584181
##             [,7]        [,8]        [,9]        [,10]
##  [1,]  0.4280244  1.11159547 -0.91902508  0.707781840
##  [2,] -0.4394559  0.07019018 -0.93151708  0.002535151
##  [3,] -1.0507978  1.02956213 -0.62964410  0.547239159
##  [4,] -0.3335883 -0.69379241 -0.23283439 -0.123079915
##  [5,]  0.6774652  1.19242480  0.83720484 -0.201730788
##  [6,] -0.3809098 -3.43342952 -0.35759746 -0.583710114
##  [7,] -1.5349081  0.25813528 -0.01897416  1.432685303
##  [8,]  0.5908791 -0.71542911 -0.94685883 -0.581584165
##  [9,]  0.2860523  0.02132089 -1.80183807 -1.222973394
## [10,] -1.1882765  0.49286748 -1.83119703 -0.762659302</code></pre>
<p>and this one, which generates a single long string:</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz&quot;</code></pre>
</div>
<div id="enter-knitr-hooks" class="section level2">
<h2>Enter: knitr hooks</h2>
<p>As detailed by the <a href="https://yihui.name/knitr/hooks/">knitr documentation</a>, <code>knitr</code> provides a set of functions to transparently modify a chunk, without changing the inner contents, but specifying chunk options. Such functions are called <strong>hooks</strong>.</p>
<p>Knitr hooks can be of two types: chunk hooks, output hooks and option hooks.<br />
To our purpose, we are interested in <strong>output hooks</strong>.</p>
<p>These are functions which, in general, take two parameters: the chunk output, and the chunk options (e.g. <code>fig.width</code>).</p>
<p>From the <a href="https://yihui.name/knitr/hooks/#output-hooks">documentation</a>, an output hook can deal with 8 different types of outputs:</p>
<ul>
<li><em>source</em>: the source code</li>
<li><em>output</em>: ordinary R output (i.e., what would have been printed in an R terminal) except warnings, messages and errors</li>
<li><em>warning</em>: warnings from warning()</li>
<li><em>message</em>: messages from message()</li>
<li><em>error</em>: errors from stop() (applies to errors in both code chunks and inline R code)</li>
<li><em>plot</em>: graphics output</li>
<li><em>inline</em>: output of inline R code</li>
<li><em>chunk</em>: all the output of a chunk (i.e., those produced by the previous hooks)</li>
<li><em>document</em>: the output of the whole document (is base::identity by default)</li>
</ul>
<p>Again, we are interested in output hooks for the output, as we want to preserve source code, errors, warnings and messages.</p>
<div id="line-truncation" class="section level3">
<h3>Line truncation</h3>
<p>This is directly taken from knitr examples: <a href="https://github.com/yihui/knitr-examples/blob/master/052-suppress-output.Rmd"><code>052-suppress-output.Rmd</code></a></p>
<p>First, e.g. in the setup chunk, we retrieve the default output hook:</p>
<pre class="r"><code># the default output hook
hook_output_default &lt;- knitr::knit_hooks$get(&#39;output&#39;)</code></pre>
<p>We define a function which truncates the output up to <code>n</code> lines. <code>x</code> is the chunk output, as a character vector. If <code>n</code> is missing, the output passes through, unaffected.</p>
<pre class="r"><code>truncate_to_lines &lt;- function(x, n) {
   if (!is.null(n)) {
      x = unlist(stringr::str_split(x, &#39;\n&#39;))
      if (length(x) &gt; n) {
         # truncate the output
         x = c(head(x, n), &#39;...\n&#39;)
      }
      x = paste(x, collapse = &#39;\n&#39;) # paste first n lines together
   }
   x
}</code></pre>
<p>Finally, we can overwrite the default knitr hook, and truncate if option <code>max.lines</code> is specified:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
   max.lines &lt;- options$max.lines
   x &lt;- truncate_to_lines(x, max.lines)

   hook_output_default(x, options)
})</code></pre>
<p>Let’s see the first chunk, now truncated to 3 lines. We set <code>max.lines=3</code> in the chunk options:</p>
<pre class="md"><code>`​​``{​r, max.lines = 3}
n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
`​``</code></pre>
<p>and here is the output:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##             [,1]       [,2]        [,3]       [,4]       [,5]        [,6]
##  [1,] -1.8133013  0.4648937  2.74734614  1.7142601  0.1515580  1.26426939
##  [2,]  0.4000006 -1.7502517 -0.38417693  0.2618068 -0.3786681 -0.43263902
...</code></pre>
</div>
<div id="character-truncation" class="section level3">
<h3>Character truncation</h3>
<p>This time we need to define a function which truncates up to a specified amount of characters, if <code>n_chars</code> is specified:</p>
<pre class="r"><code>truncate_to_chars &lt;- function(x, n_chars) {
   if (!is.null(n_chars)) {
      if (min(nchar(x), n_chars) &lt; nchar(x)) {
         x &lt;- substr(x, 1, min(nchar(x), n_chars))
         x &lt;- paste(x, &#39; ...\n&#39;)
      }
   }
   x
}</code></pre>
<p>Then, we can add the truncation function to the output hook:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
    max.lines &lt;- options$max.lines
    x &lt;- truncate_to_lines(x, max.lines)

    # Here is our new code
    max.chars &lt;- options$max.chars
    x &lt;- truncate_to_chars(x, max.chars)

    hook_output_default(x, options)
})</code></pre>
<p>And here is the second chunk, truncated to 20 chars (setting <code>max.chars = 20</code> in the chunk options):</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijkl  ...</code></pre>
<p>Notice that the code is not part of the character count (it is an output hook on the <em>output</em>!), but the prompt and the whitespaces are (up to <code>&quot;...&quot;</code>).</p>
<hr />
<p>And, of course, both truncations can be combined.<br />
E.g., let’s see the first chunk to 3 lines and 160 characters:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##             [,1]        [,2]       [,3]        [,4]       [,5]
##  [1,]  1.0017233 -1.60339739  0.6153917  1.65707549 -0.8824068
##  [2,]  1.0742765 -1.60082  ...</code></pre>
<p>Thanks for reading!</p>
</div>
</div>
