---
title: "Controlling long outputs with knitr hooks"
draft: false
categories: ["blog"]
tags: ["R", "blogdown", "knitr", "hooks", "snippets"]
date: "2018-05-30"
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This blog is written in a combination of Markdown and R Markdown (using the R package {{% cran "blogdown" %}}).</p>
<p>As such, some R Markdown posts contain code chunks who generate very lengthy and verbose output.<br />
An example is this one, which generates a sequence of strings separated by newlines:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##             [,1]       [,2]       [,3]       [,4]         [,5]       [,6]
##  [1,] -0.5295704  0.3961161 -0.2057667  1.3845750  1.918935049  0.4145720
##  [2,]  0.8226785 -0.6866140 -0.0428824  0.4396269 -0.002287852 -0.6181170
##  [3,] -1.0929518 -2.7791168  1.4610613 -0.4983765  2.089596363 -0.1327685
##  [4,] -0.6124149 -1.0603217 -1.0654193  1.0229031 -0.627464965 -1.7740419
##  [5,] -1.8877480 -0.8567730 -2.9601490 -1.7334441  0.150265548 -0.5366728
##  [6,] -0.1212130  2.9661761  0.5638194  0.3673028  1.215752442 -0.3772983
##  [7,] -0.3211023  0.6666485 -1.0321814 -0.3860687  0.223288863 -0.7570077
##  [8,]  1.5262871 -1.0757069  1.3518880 -1.5701558  0.121694462  0.4857518
##  [9,]  0.6236220  0.3342959  0.1013965  1.9796573  0.460064913 -1.3016096
## [10,] -1.1421243 -0.7334670 -0.6915663 -0.1901914  1.113988827 -1.0207699
##             [,7]        [,8]        [,9]       [,10]
##  [1,]  0.4221049  0.67810962 -0.74520372  0.22109438
##  [2,] -0.3381571 -0.41087125 -1.06349163 -0.33472453
##  [3,] -1.2633350 -0.26222785  2.18002818  0.11126416
##  [4,] -2.0380786 -0.61197247  1.07141091  0.67648691
##  [5,]  0.9060663  1.10548058  0.82037296  0.09020505
##  [6,] -0.3757222 -0.06256541  0.03494444  1.54151727
##  [7,] -1.5652167 -0.74746544  1.84773491  0.28563948
##  [8,] -0.3694505 -0.89673698  0.08654417 -0.88548662
##  [9,]  1.4577233  0.38583116  0.56846251  1.27704004
## [10,] -0.4250752  0.54352017  0.07157971 -0.16577904</code></pre>
<p>and this one, which generates a single long string:</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz&quot;</code></pre>
</div>
<div id="enter-knitr-hooks" class="section level2">
<h2>Enter: knitr hooks</h2>
<p>As detailed by the <a href="https://yihui.name/knitr/hooks/">knitr documentation</a>, <code>knitr</code> provides a set of functions to transparently modify a chunk, without changing the inner contents, but specifying chunk options. Such functions are called <strong>hooks</strong>.</p>
<p>Knitr hooks can be of two types: chunk hooks, output hooks and option hooks.<br />
To our purpose, we are interested in <strong>output hooks</strong>.</p>
<p>These are functions which, in general, take two parameters: the chunk output, and the chunk options (e.g. <code>fig.width</code>).</p>
<p>From the <a href="https://yihui.name/knitr/hooks/#output-hooks">documentation</a>, an output hook can deal with 8 different types of outputs:</p>
<ul>
<li><em>source</em>: the source code</li>
<li><em>output</em>: ordinary R output (i.e., what would have been printed in an R terminal) except warnings, messages and errors</li>
<li><em>warning</em>: warnings from warning()</li>
<li><em>message</em>: messages from message()</li>
<li><em>error</em>: errors from stop() (applies to errors in both code chunks and inline R code)</li>
<li><em>plot</em>: graphics output</li>
<li><em>inline</em>: output of inline R code</li>
<li><em>chunk</em>: all the output of a chunk (i.e., those produced by the previous hooks)</li>
<li><em>document</em>: the output of the whole document (is base::identity by default)</li>
</ul>
<p>Again, we are interested in output hooks for the output, as we want to preserve source code, errors, warnings and messages.</p>
<div id="line-truncation" class="section level3">
<h3>Line truncation</h3>
<p>This is directly taken from knitr examples: <a href="https://github.com/yihui/knitr-examples/blob/master/052-suppress-output.Rmd"><code>052-suppress-output.Rmd</code></a></p>
<p>First, e.g. in the setup chunk, we retrieve the default output hook:</p>
<pre class="r"><code># the default output hook
hook_output_default &lt;- knitr::knit_hooks$get(&#39;output&#39;)</code></pre>
<p>We define a function which truncates the output up to <code>n</code> lines. <code>x</code> is the chunk output, as a character vector. If <code>n</code> is missing, the output passes through, unaffected.</p>
<pre class="r"><code>truncate_to_lines &lt;- function(x, n) {
   if (!is.null(n)) {
      x = unlist(stringr::str_split(x, &#39;\n&#39;))
      if (length(x) &gt; n) {
         # truncate the output
         x = c(head(x, n), &#39;...\n&#39;)
      }
      x = paste(x, collapse = &#39;\n&#39;) # paste first n lines together
   }
   x
}</code></pre>
<p>Finally, we can overwrite the default knitr hook, and truncate if option <code>max.lines</code> is specified:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
   max.lines &lt;- options$max.lines
   x &lt;- truncate_to_lines(x, max.lines)

   hook_output_default(x, options)
})</code></pre>
<p>Let’s see the first chunk, now truncated to 3 lines. We set <code>max.lines=3</code> in the chunk options:</p>
<pre class="md"><code>`​​``{​r, max.lines = 3}
n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
`​``</code></pre>
<p>and here is the output:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##              [,1]       [,2]        [,3]        [,4]        [,5]
##  [1,] -0.04931145  1.5588907 -0.16380949  1.11705689  1.49526315
##  [2,] -1.25645358  0.3182689  1.52772823 -0.44897891  0.42336492
...</code></pre>
</div>
<div id="character-truncation" class="section level3">
<h3>Character truncation</h3>
<p>This time we need to define a function which truncates up to a specified amount of characters, if <code>n_chars</code> is specified:</p>
<pre class="r"><code>truncate_to_chars &lt;- function(x, n_chars) {
   if (!is.null(n_chars)) {
      if (min(nchar(x), n_chars) &lt; nchar(x)) {
         x &lt;- substr(x, 1, min(nchar(x), n_chars))
         x &lt;- paste(x, &#39; ...\n&#39;)
      }
   }
   x
}</code></pre>
<p>Then, we can add the truncation function to the output hook:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
    max.lines &lt;- options$max.lines
    x &lt;- truncate_to_lines(x, max.lines)

    # Here is our new code
    max.chars &lt;- options$max.chars
    x &lt;- truncate_to_chars(x, max.chars)

    hook_output_default(x, options)
})</code></pre>
<p>And here is the second chunk, truncated to 20 chars (setting <code>max.chars = 20</code> in the chunk options):</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijkl  ...</code></pre>
<p>Notice that the code is not part of the character count (it is an output hook on the <em>output</em>!), but the prompt and the whitespaces are (up to <code>&quot;...&quot;</code>).</p>
<hr />
<p>And, of course, both truncations can be combined.<br />
E.g., let’s see the first chunk to 3 lines and 160 characters:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##              [,1]        [,2]       [,3]        [,4]        [,5]
##  [1,] -0.71857820  0.23227109 -0.3785270 -0.08007944 -0.37064788
##  [2,]  1.25163403  1.  ...</code></pre>
<p>Thanks for reading!</p>
</div>
</div>
