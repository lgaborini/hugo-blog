---
title: "Controlling long outputs with knitr hooks"
draft: false
categories: ["blog"]
tags: ["R", "blogdown", "knitr", "hooks", "snippets"]
date: "2018-05-30"
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This blog is written in a combination of Markdown and R Markdown (using the R package {{% cran "blogdown" %}}).</p>
<p>As such, some R Markdown posts contain code chunks who generate very lengthy and verbose output.<br />
An example is this one, which generates a sequence of strings separated by newlines:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##             [,1]        [,2]         [,3]       [,4]       [,5]
##  [1,]  0.3288763 -0.81568548 -0.243159857 -0.6340709  0.1558906
##  [2,]  1.6258188 -0.07715989  0.844534138  1.6106247 -1.1008158
##  [3,] -0.6648901  0.52273133 -1.215137369 -0.3402944 -0.7301614
##  [4,]  0.3579018  0.53788327 -0.006987001  0.2929762  1.0797795
##  [5,] -0.8641968 -0.44787689 -1.254759635 -0.4427957  0.1251885
##  [6,]  1.4446856 -0.03659808  0.623738991  0.3232974  0.6093337
##  [7,]  1.5876329  0.62700738  0.185525858  0.6961908  0.8954866
##  [8,] -0.5591465 -1.26731533 -1.545922968 -0.7895989  1.3176682
##  [9,]  0.6543044  0.27471461  0.525049990 -1.5923718  0.8195625
## [10,] -0.7593611 -0.32772031 -1.225090234 -0.1907982  0.1501943
##              [,6]       [,7]         [,8]       [,9]       [,10]
##  [1,]  0.70005596 -0.9523808  1.686830324 -0.3078440 -0.03551203
##  [2,]  1.16278015  1.7479233 -1.045325022 -1.2277765 -0.12379876
##  [3,]  1.32256047 -0.4894026 -0.211290839 -0.4139337  0.13986846
##  [4,]  1.01940807  0.1849684  1.815482054 -0.6817079  0.87781097
##  [5,]  1.21881815 -0.3967694 -1.507027318 -0.7626443 -0.84523738
##  [6,]  0.25891578  1.4401777  1.461646307 -1.9291132  0.29078630
##  [7,] -0.06101642  0.4804541  0.740070268  0.9003656 -0.17752950
##  [8,]  0.15090119 -1.7002186 -0.204518480 -0.3562340  1.49687177
##  [9,] -0.19337796 -0.2547372 -0.008607973 -1.2388604 -1.15822061
## [10,]  0.98967692  0.0770775  0.100776725 -0.7144160  0.60519140</code></pre>
<p>and this one, which generates a single long string:</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz&quot;</code></pre>
</div>
<div id="enter-knitr-hooks" class="section level2">
<h2>Enter: knitr hooks</h2>
<p>As detailed by the <a href="https://yihui.name/knitr/hooks/">knitr documentation</a>, <code>knitr</code> provides a set of functions to transparently modify a chunk, without changing the inner contents, but specifying chunk options. Such functions are called <strong>hooks</strong>.</p>
<p>Knitr hooks can be of two types: chunk hooks, output hooks and option hooks.<br />
To our purpose, we are interested in <strong>output hooks</strong>.</p>
<p>These are functions which, in general, take two parameters: the chunk output, and the chunk options (e.g. <code>fig.width</code>).</p>
<p>From the <a href="https://yihui.name/knitr/hooks/#output-hooks">documentation</a>, an output hook can deal with 8 different types of outputs:</p>
<ul>
<li><em>source</em>: the source code</li>
<li><em>output</em>: ordinary R output (i.e., what would have been printed in an R terminal) except warnings, messages and errors</li>
<li><em>warning</em>: warnings from warning()</li>
<li><em>message</em>: messages from message()</li>
<li><em>error</em>: errors from stop() (applies to errors in both code chunks and inline R code)</li>
<li><em>plot</em>: graphics output</li>
<li><em>inline</em>: output of inline R code</li>
<li><em>chunk</em>: all the output of a chunk (i.e., those produced by the previous hooks)</li>
<li><em>document</em>: the output of the whole document (is base::identity by default)</li>
</ul>
<p>Again, we are interested in output hooks for the output, as we want to preserve source code, errors, warnings and messages.</p>
<div id="line-truncation" class="section level3">
<h3>Line truncation</h3>
<p>This is directly taken from knitr examples: <a href="https://github.com/yihui/knitr-examples/blob/master/052-suppress-output.Rmd"><code>052-suppress-output.Rmd</code></a></p>
<p>First, e.g. in the setup chunk, we retrieve the default output hook:</p>
<pre class="r"><code># the default output hook
hook_output_default &lt;- knitr::knit_hooks$get(&#39;output&#39;)</code></pre>
<p>We define a function which truncates the output up to <code>n</code> lines. <code>x</code> is the chunk output, as a character vector. If <code>n</code> is missing, the output passes through, unaffected.</p>
<pre class="r"><code>truncate_to_lines &lt;- function(x, n) {
   if (!is.null(n)) {
      x = unlist(stringr::str_split(x, &#39;\n&#39;))
      if (length(x) &gt; n) {
         # truncate the output
         x = c(head(x, n), &#39;...\n&#39;)
      }
      x = paste(x, collapse = &#39;\n&#39;) # paste first n lines together
   }
   x
}</code></pre>
<p>Finally, we can overwrite the default knitr hook, and truncate if option <code>max.lines</code> is specified:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
   max.lines &lt;- options$max.lines
   x &lt;- truncate_to_lines(x, max.lines)

   hook_output_default(x, options)
})</code></pre>
<p>Let’s see the first chunk, now truncated to 3 lines. We set <code>max.lines=3</code> in the chunk options:</p>
<pre class="md"><code>`​​``{​r, max.lines = 3}
n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
`​``</code></pre>
<p>and here is the output:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##              [,1]        [,2]       [,3]       [,4]       [,5]       [,6]
##  [1,] -0.26335668  1.44161366  0.8603514 -0.8417015 -1.1918365 -0.5814300
##  [2,] -1.02903185  0.10374382  1.5809012  1.0533777 -0.9455260 -1.0109838
...</code></pre>
</div>
<div id="character-truncation" class="section level3">
<h3>Character truncation</h3>
<p>This time we need to define a function which truncates up to a specified amount of characters, if <code>n_chars</code> is specified:</p>
<pre class="r"><code>truncate_to_chars &lt;- function(x, n_chars) {
   if (!is.null(n_chars)) {
      if (min(nchar(x), n_chars) &lt; nchar(x)) {
         x &lt;- substr(x, 1, min(nchar(x), n_chars))
         x &lt;- paste(x, &#39; ...\n&#39;)
      }
   }
   x
}</code></pre>
<p>Then, we can add the truncation function to the output hook:</p>
<pre class="r"><code>knitr::knit_hooks$set(output = function(x, options) {
    max.lines &lt;- options$max.lines
    x &lt;- truncate_to_lines(x, max.lines)

    # Here is our new code
    max.chars &lt;- options$max.chars
    x &lt;- truncate_to_chars(x, max.chars)

    hook_output_default(x, options)
})</code></pre>
<p>And here is the second chunk, truncated to 20 chars (setting <code>max.chars = 20</code> in the chunk options):</p>
<pre class="r"><code>long_string &lt;- paste(rep(letters, 30), collapse = &#39;&#39;)
long_string
## [1] &quot;abcdefghijkl  ...</code></pre>
<p>Notice that the code is not part of the character count (it is an output hook on the <em>output</em>!), but the prompt and the whitespaces are (up to <code>&quot;...&quot;</code>).</p>
<hr />
<p>And, of course, both truncations can be combined.<br />
E.g., let’s see the first chunk to 3 lines and 160 characters:</p>
<pre class="r"><code>n &lt;- 10
m &lt;- 10
matrix(rnorm(m*n), m, n)
##              [,1]         [,2]        [,3]        [,4]        [,5]
##  [1,]  2.20772825 -1.241702944 -0.44701352 -0.45900934  1.35515233
##  [2,] -2.01250774  ...</code></pre>
<p>Thanks for reading!</p>
</div>
</div>
